%% EXAMPLE: Differential drive vehicle following waypoints using the 
% Pure Pursuit algorithm
% Copyright 2018-2019 The MathWorks, Inc.

%% Define Vehicle
R = 0.01;                % Wheel radius [m]
L = 0.5;                % Wheelbase [m]
dd = DifferentialDrive(R,L);

%% Simulation parameters
sampleTime = 0.01;               % Sample time [s]
tVec = 0:sampleTime:600;         % Time array

initPose = [0;0;1/2*pi];             % Initial pose (x y theta)/
pose = zeros(3,numel(tVec));    % Pose matrix
pose(:,1) = initPose;

% Define waypoints
waypoints = [0,0;
             2.4249969671719,-3.5497232869964;
             5.7120036935056,-1.1392516876851;
             9.4372779833504,1.7094874751374;
             12.7242847096841,4.7773604197156;
             15.3538900907511,10.6939725271162;
             15.3538900907511,14.419246816961;
             13.1625522731953,17.2679859797835;
             10.5329468921283,20.1167251426061;
             11.1903482373951,23.6228656506953;
             11.6529639988791,27.2385730496624;
             9.510322577269,27.4333586334451;
             6.4911460286366,27.4333586334451;
             1.6215064340681,26.5568235064228;
             1.6215064340681,28.1151081766847;
             5.809396485397,28.991643303707;
             10,30;
             13.4060342529237,27.4333586334451;
             12.6268919177928,25.4855027956177;
             9.0233586178121,23.7324325415731;
             6.880717196202,25.1933244199436;
             3.958933439461,25.1933244199436;
             2.7902199367646,23.440254165899;
             4.8354685664833,22.4663262469853;
             7.7572523232244,22.4663262469853;
             10.1920721205086,23.5863433537361;
             12.0749994304084,24.7550568564325;
             13.3735699889599,26.3133415266944;
             12.9190702934669,29.3649823392906;
             11.815285318698,30.4687673140594;
             9.5427868412328,33.6502651825108;
             7.7897165871881,36.2474062996139;
             5.6612894615347,38.1687619377727;
             2.4707560528602,41.5469737822516;
             -1.6581695348362,42.2976875254692;
             -4.4733460719019,41.3592953464472;
             -6.791698333287,41.7676068158356;
             -9.7571624728601,42.4595484484026;
             -9.1640696449455,46.8088958531099;
             -6.6928495286346,50.0709064066404;
             -2.1458045146224,51.2570920624697;
             0,50;
             2.00584528078,49.2801159694209;
             4.477065397091,49.1812671647685;
             6.7505879040971,48.1927791182441;
             9.4195056297129,46.9077446577624;
             11.9895745506763,44.9307685647136;
             13.4723066204629,42.5583972530551;
             15.745829127469,41.5699092065307;
             18.21704924378,40.284874746049;
             19.4032348996092,37.5171082157807;
             20.9848157740482,35.5401321227319;
             24.543372741536,33.9585512482929;
             24.2468263275787,31.2896335226771;
             24.2468263275787,29.2138086249759;
             25.5318607880604,27.1379837272747;
             26.124953615975,25.2598564388783;
             28.1019297090238,24.8644612202686;
             28.4973249276336,23.1840315411771;
             28.1019297090238,21.1082066434759;
             27.3111392718043,19.7243233783418;
             28.6950225369384,17.9450448945979;
             27.4099880764567,16.9565568480735;
             28.9915689508958,15.7703711922442;
             28.9915689508958,13.3979998805857;
             28.596173732286,10.7290821549698;
             27.5088368811092,9.3451988898357;
             26.8168952485421,7.4670716014394;
             27.7065344904141,5.6877931176955;
             28.8927201462433,4.007363438604;
             28.1019297090238,2.425782564165;
             26.6191976392372,-0.4408327707557;
             23.1594894764019,-0.5396815754082;
             21.6767574066153,-0.8362279893655;
             23.6537334996641,-2.6155064731094;
             23.5548846950116,-4.098238542896;
             20,-5;
             15,-5;
             13.7688530344202,-2.4178088638045;
             13.8677018390727,0.5476552757687;
             12.4838185739385,2.2280849548601;
             11.3964817227617,3.3154218060369;
             8.2333199738837,0.3499576664638;
             4.2793677877861,-2.5166576684569;
             0.1277179923837,-3.208599301024;
             -3.5296877797565,-1.4293208172801;
             -5.7043614821102,-0.1442863567984;
             -7.0882447472443,1.2395969083357;
             -9.7571624728601,3.7108170246467;
             -5.4078150681529,6.2808859456101;
             -2.3435021239273,6.478583554915;
             0.0288691877313,6.0831883363052;
             2.1046940854325,7.0716763828296;
             4.6747630063959,6.7751299688723;
             6.3551926854873,6.478583554915;
             3.8839725691764,4.007363438604;
             0.424264406341,3.2165730013845;
             -3.1342925611468,3.6119682199943;
             -11.2398945426467,5.4900955083906;
             -12.1295337845187,7.0716763828296;
             -13.7111146589577,9.5428964991406;
             -14.897300314787,12.112965420104;
             -16.7754276031833,14.4853367317625;
             -17.5662180404028,16.9565568480735;
             -17.7639156497077,20.0208697922991;
             -17.0719740171406,23.7771243690917;
             -15.9846371659638,27.0391349226222;
             -12.426080198476,28.4230181877564;
             -8.2744304030736,28.5218669924088;
             -6.1986055053724,27.9287741644942;
             -7.1870935518967,26.4460420947076;
             -10.5479529100797,26.3471932900551;
             -13.9088122682626,26.6437397040125;
             -17.170822821793,25.5564028528356;
             -17.5662180404028,21.9978458853478;
             -14.897300314787,21.800148276043;
             -11.9318361752138,24.1725195877015;
             -8.8675232309882,24.6667636109637;
             -6.8905471379394,23.2828803458295;
             -5.902059091415,22.0966946900003;
             -3.628536584409,21.3059042527808;
             -3.5296877797565,18.4392889178601;
             -3.9250829983663,16.3634640201588;
             -5,15;
             -5.5066638728053,12.6072094433662;
             -4.0239318030187,11.4210237875369;
             -2.5411997332321,11.4210237875369;
             0,10;
             2.00584528078,12.2118142247564;
             4.3782165924386,12.5083606387137;
             3.1920309366093,15.3749759736345;
             1.1162060389081,19.1312305504271;
             0.424264406341,22.5909387132625;
             0,25;
             0.7208108202983,20.910509034171;
             2.3023916947374,18.0438936992503;
             4.2793677877861,14.1887903178052;
             3.2908797412617,12.3106630294089;
             1.2150548435605,10.6302333503174;
             -1.3550140774029,10.2348381317076;
             -3.1342925611468,11.3221749828845;
             -4.6170246309333,11.8164190061467;
             -5.5066638728053,14.1887903178052;
             -3.4308389751041,17.1542544573783;
             -3.1342925611468,19.8231721829942;
             -4.8147222402382,21.7012994713905;
             -7.5824887705065,21.3059042527808;
             -9.7571624728601,20.8116602295186;
             -12.6237778077809,21.2070554481283;
             -16.1823347752687,21.8989970806954;
             -16.8742764078357,26.8414373133173;
             -15.7869395566589,30.3999942808051;
             -15.6880907520065,32.5746679831588;
             -15.9846371659638,36.1332249506466;
             -12.9203242217382,40.1860259413966;
             -10.3502553007748,44.0411293228417;
             -10.2514064961223,48.0939303135916;
             -13.2168706356955,46.5123494391526;
             -16.9731252124882,44.0411293228417;
             -18.060462063665,42.0641532297929;
             -20,40;
             -22.0144142497625,38.3078986530002;
             -23.694843928854,35.6389809273844;
             -24.1314261494023,33.6455300335601;
             -25.3176118052315,31.4708563312065;
             -25.9107046331462,29.2302834257512;
             -27.4263863044835,27.9122993637187;
             -28.0194791323982,25.8035248644667;
             -28.6784711634144,24.0242463807228;
             -29.7328584130404,21.5859758659626;
             -31.5121368967843,20.7292862256415;
             -31.5121368967843,18.2910157108813;
             -30.3259512409551,16.5776364302391;
             -28.2171767417031,15.3255515713082;
             -28.8102695696177,13.3485754782594;
             -30.1941528347518,12.2282890255318;
             -31.8416329122925,10.778506557296;
             -32.3688265371055,9.3946232921619;
             -32.1711289278006,6.6268567618936;
             -30,5;
             -27.9206303277457,2.6976167769591;
             -26.5861714649378,0.4735186722793;
             -25.2517126021299,-2.6402186742725;
             -23.3241609114073,-7.0884148836323;
             -20.8035163927702,-8.1263273324829;
             -17.393232632261,-9.1642397813335;
             -15.0208613206025,-12.426250334864;
             -10.2761186972855,-12.5745235418426;
             -6.2727421088617,-8.8676933673762;
             -6.4210153158404,-5.902229227803;
             -6.8658349367763,-2.1953990533366];

% Create visualizer
viz = Visualizer2D;
viz.hasWaypoints = true;

%% Pure Pursuit Controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
controller.LookaheadDistance = .7;
controller.DesiredLinearVelocity = .9;
controller.MaxAngularVelocity = 10;

%% Simulation loop
close all
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec) 
    % Run the Pure Pursuit controller and convert output to wheel speeds
    [vRef,wRef] = controller(pose(:,idx-1));
    [wL,wR] = inverseKinematics(dd,vRef,wRef);
    
    % Compute the velocities
    [v,w] = forwardKinematics(dd,wL,wR);
    velB = [v;0;w]; % Body velocities [vx;vy;w]
    vel = bodyToWorld(velB,pose(:,idx-1));  % Convert from body to world
    
    % Perform forward discrete integration step
    pose(:,idx) = pose(:,idx-1) + vel*sampleTime; 
    
    % Update visualization
    viz(pose(:,idx),waypoints);
    waitfor(r);
end